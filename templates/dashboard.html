<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Candle Bot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script> <!-- Include Lightweight Charts -->
</head>
<body>
    <div class="navbar">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="CandleBot Logo" class="minilogo">
        <span>Hi, {{ full_name }}!</span>
        <div class="nav-links">
            <a href="/dashboard">Search</a>
            <a href="/portfolio">Portfolio</a>
            <a href="/screener">Screener</a>
            <a href="/analysis">Analysis</a>
            <a href="/logout" class="logout-button">Log Out</a>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="search-bar" placeholder="Search stocks...">
        <p>Period :</p>
        <select id="period-selector">
            <option value="max">Full</option>
            <option value="None">By Dates</option>
            <option value="1d">1 day</option>
            <option value="5d">5 day</option>
            <option value="1mo">1 month</option>
            <option value="3mo">3 months</option>
            <option value="6mo">6 months</option>
            <option value="1y">1 year</option>
            <option value="2y">2 years</option>
            <option value="3y">5 years</option>
            <option value="10y">10 years</option>
            <option value="ytd">Year2Date</option>
        </select>
        <p>Interval :</p>
        <select id="interval-selector">
            <option value="1d">Daily</option>
            <option value="1wk">Weekly</option>
            <option value="1mo">Monthly</option>
            <option value="1m">1 Minute</option>
            <option value="2m">2 Minutes</option>
            <option value="5m">5 Minutes</option>
            <option value="15m">15 Minutes</option>
            <option value="30m">30 Minutes</option>
            <option value="1h">Hourly</option>
            <option value="5d">5 Days</option>
            <option value="3mo">3 Months</option>
        </select>
        <div id="date-inputs" style="display: none;">
            <p>Start-Date : </p>
            <input type="date" id="start-date" class="dates">
            <p>End-Date : </p>
            <input type="date" id="end-date" class="dates">
        </div>
        <button id="search-button" class ="search-button">Search</button>
    </div>

    <div id="chart"></div>

    <script>
        document.getElementById('period-selector').addEventListener('change', function() {
            const value = this.value;
            const dateInputs = document.getElementById('date-inputs');
            if (value === 'None') {
                dateInputs.style.display = 'flex';
            } else {
                dateInputs.style.display = 'none';
            }
        });
        var clicked=0
        document.getElementById('search-button').addEventListener('click', function() {
            const stockSymbol = document.getElementById('search-bar').value;
            const period = document.getElementById('period-selector').value;
            const interval = document.getElementById('interval-selector').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (clicked==0){
                clicked = 1
            }
            else if(clicked==1){
                clicked = 2
            }
            // Fetch stock data and render chart
            fetchStockData(stockSymbol, period, interval, startDate, endDate);
        });
    
        function fetchStockData(stockSymbol, period, interval, startDate, endDate) {
            if (period != "None"){
                startDate="None"
                endDate="None"
            }
            const url = `/fetch_stock_data?symbol=${stockSymbol}&period=${period}&interval=${interval}&start=${startDate}&end=${endDate}`;
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    renderChart(data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Failed to fetch stock data. Please try again.');
                });
        }
        
        function renderChart(data) {
            if(clicked==2){
                const elements = document.getElementsByClassName("tv-lightweight-charts");
                while (elements.length > 0) {
                    elements[0].remove(); // Remove the first element in the collection
                }
            }
            
            const chart = LightweightCharts.createChart(document.getElementById('chart'), {
                // width: document.getElementById('chart').clientWidth,
                // height: document.getElementById('chart').clientHeight,
            });
    
            const lineSeries = chart.addCandlestickSeries({
                upColor: 'green',
                downColor: 'red',
                borderUpColor: 'green',
                borderDownColor: 'red',
                wickUpColor: 'green',
                wickDownColor: 'red',
            });
    
            lineSeries.setData(data);
        }
    </script>
</body>
</html>